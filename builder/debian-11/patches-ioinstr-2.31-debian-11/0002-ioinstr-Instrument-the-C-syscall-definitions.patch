From 2079819d9ec48821d5022def79da5949320b87d2 Mon Sep 17 00:00:00 2001
From: Sebastien Valat <sebastien.valat.dev@orange.fr>
Date: Sat, 26 Mar 2022 11:03:10 +0100
Subject: [PATCH 2/3] ioinstr: Instrument the C syscall definitions

---
 sysdeps/unix/sysv/linux/x86_64/sysdep.h | 31 +++++++++++++++++++++++++
 1 file changed, 31 insertions(+)

diff --git a/sysdeps/unix/sysv/linux/x86_64/sysdep.h b/sysdeps/unix/sysv/linux/x86_64/sysdep.h
index c7f740a1..53e037df 100644
--- a/sysdeps/unix/sysv/linux/x86_64/sysdep.h
+++ b/sysdeps/unix/sysv/linux/x86_64/sysdep.h
@@ -26,6 +26,9 @@
 /* Defines RTLD_PRIVATE_ERRNO.  */
 #include <dl-sysdep.h>
 
+/* Interception mechanism */
+#include <ioinstr.h>
+
 /* For Linux we can use the system call table in the header file
 	/usr/include/asm/unistd.h
    of the kernel.  But these symbols do not follow the SYS_* syntax
@@ -275,11 +278,15 @@
 #define internal_syscall0(number, err, dummy...)			\
 ({									\
     unsigned long int resultvar;					\
+    int intercep_result = GLIBC_SYSCALL_NO_INTERCEPT; \
+    GLIBC_SYSCALL_INTERCEPT(&(resultvar), (number), 0, 0, 0, 0, 0, 0); \
+    if (intercep_result == GLIBC_SYSCALL_NO_INTERCEPT) {\
     asm volatile (							\
     "syscall\n\t"							\
     : "=a" (resultvar)							\
     : "0" (number)							\
     : "memory", REGISTERS_CLOBBERED_BY_SYSCALL);			\
+    }\
     (long int) resultvar;						\
 })
 
@@ -287,6 +294,9 @@
 #define internal_syscall1(number, err, arg1)				\
 ({									\
     unsigned long int resultvar;					\
+    int intercep_result = GLIBC_SYSCALL_NO_INTERCEPT; \
+    GLIBC_SYSCALL_INTERCEPT(&(resultvar), (number), (long)(arg1), 0, 0, 0, 0, 0); \
+    if (intercep_result == GLIBC_SYSCALL_NO_INTERCEPT) {\
     TYPEFY (arg1, __arg1) = ARGIFY (arg1);			 	\
     register TYPEFY (arg1, _a1) asm ("rdi") = __arg1;			\
     asm volatile (							\
@@ -294,6 +304,7 @@
     : "=a" (resultvar)							\
     : "0" (number), "r" (_a1)						\
     : "memory", REGISTERS_CLOBBERED_BY_SYSCALL);			\
+    }\
     (long int) resultvar;						\
 })
 
@@ -301,6 +312,9 @@
 #define internal_syscall2(number, err, arg1, arg2)			\
 ({									\
     unsigned long int resultvar;					\
+    int intercep_result = GLIBC_SYSCALL_NO_INTERCEPT; \
+    GLIBC_SYSCALL_INTERCEPT(&(resultvar), (number), (long)(arg1), (long)(arg2), 0, 0, 0, 0); \
+    if (intercep_result == GLIBC_SYSCALL_NO_INTERCEPT) {\
     TYPEFY (arg2, __arg2) = ARGIFY (arg2);			 	\
     TYPEFY (arg1, __arg1) = ARGIFY (arg1);			 	\
     register TYPEFY (arg2, _a2) asm ("rsi") = __arg2;			\
@@ -310,6 +324,7 @@
     : "=a" (resultvar)							\
     : "0" (number), "r" (_a1), "r" (_a2)				\
     : "memory", REGISTERS_CLOBBERED_BY_SYSCALL);			\
+    }\
     (long int) resultvar;						\
 })
 
@@ -317,6 +332,9 @@
 #define internal_syscall3(number, err, arg1, arg2, arg3)		\
 ({									\
     unsigned long int resultvar;					\
+    int intercep_result = GLIBC_SYSCALL_NO_INTERCEPT; \
+    GLIBC_SYSCALL_INTERCEPT(&(resultvar), (number), (long)(arg1), (long)(arg2), (long)(arg3), 0, 0, 0); \
+    if (intercep_result == GLIBC_SYSCALL_NO_INTERCEPT) {\
     TYPEFY (arg3, __arg3) = ARGIFY (arg3);			 	\
     TYPEFY (arg2, __arg2) = ARGIFY (arg2);			 	\
     TYPEFY (arg1, __arg1) = ARGIFY (arg1);			 	\
@@ -328,6 +346,7 @@
     : "=a" (resultvar)							\
     : "0" (number), "r" (_a1), "r" (_a2), "r" (_a3)			\
     : "memory", REGISTERS_CLOBBERED_BY_SYSCALL);			\
+    }\
     (long int) resultvar;						\
 })
 
@@ -335,6 +354,9 @@
 #define internal_syscall4(number, err, arg1, arg2, arg3, arg4)		\
 ({									\
     unsigned long int resultvar;					\
+    int intercep_result = GLIBC_SYSCALL_NO_INTERCEPT; \
+    GLIBC_SYSCALL_INTERCEPT(&(resultvar), (number), (long)(arg1), (long)(arg2), (long)(arg3), (long)(arg4), 0, 0); \
+    if (intercep_result == GLIBC_SYSCALL_NO_INTERCEPT) {\
     TYPEFY (arg4, __arg4) = ARGIFY (arg4);			 	\
     TYPEFY (arg3, __arg3) = ARGIFY (arg3);			 	\
     TYPEFY (arg2, __arg2) = ARGIFY (arg2);			 	\
@@ -348,6 +370,7 @@
     : "=a" (resultvar)							\
     : "0" (number), "r" (_a1), "r" (_a2), "r" (_a3), "r" (_a4)		\
     : "memory", REGISTERS_CLOBBERED_BY_SYSCALL);			\
+    } \
     (long int) resultvar;						\
 })
 
@@ -355,6 +378,9 @@
 #define internal_syscall5(number, err, arg1, arg2, arg3, arg4, arg5)	\
 ({									\
     unsigned long int resultvar;					\
+    int intercep_result = GLIBC_SYSCALL_NO_INTERCEPT; \
+    GLIBC_SYSCALL_INTERCEPT(&(resultvar), (number), (long)(arg1), (long)(arg2), (long)(arg3), (long)(arg4), (long)(arg5), 0); \
+    if (intercep_result == GLIBC_SYSCALL_NO_INTERCEPT) {\
     TYPEFY (arg5, __arg5) = ARGIFY (arg5);			 	\
     TYPEFY (arg4, __arg4) = ARGIFY (arg4);			 	\
     TYPEFY (arg3, __arg3) = ARGIFY (arg3);			 	\
@@ -371,6 +397,7 @@
     : "0" (number), "r" (_a1), "r" (_a2), "r" (_a3), "r" (_a4),		\
       "r" (_a5)								\
     : "memory", REGISTERS_CLOBBERED_BY_SYSCALL);			\
+    }\
     (long int) resultvar;						\
 })
 
@@ -378,6 +405,9 @@
 #define internal_syscall6(number, err, arg1, arg2, arg3, arg4, arg5, arg6) \
 ({									\
     unsigned long int resultvar;					\
+    int intercep_result = GLIBC_SYSCALL_NO_INTERCEPT; \
+    GLIBC_SYSCALL_INTERCEPT(&(resultvar), (number), (long)(arg1), (long)(arg2), (long)(arg3), (long)(arg4), (long)(arg5), (long)(arg6)); \
+    if (intercep_result == GLIBC_SYSCALL_NO_INTERCEPT) {\
     TYPEFY (arg6, __arg6) = ARGIFY (arg6);			 	\
     TYPEFY (arg5, __arg5) = ARGIFY (arg5);			 	\
     TYPEFY (arg4, __arg4) = ARGIFY (arg4);			 	\
@@ -396,6 +426,7 @@
     : "0" (number), "r" (_a1), "r" (_a2), "r" (_a3), "r" (_a4),		\
       "r" (_a5), "r" (_a6)						\
     : "memory", REGISTERS_CLOBBERED_BY_SYSCALL);			\
+    } \
     (long int) resultvar;						\
 })
 
-- 
2.30.2

